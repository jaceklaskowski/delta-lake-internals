<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Demystifying inner-workings of Delta Lake"><link href=https://books.japila.pl/delta-lake-internals/commands/MergeIntoCommand/ rel=canonical><meta name=author content="Jacek Laskowski"><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.1.2, mkdocs-material-6.1.7"><title>MergeIntoCommand - The Internals of Delta Lake</title><link rel=stylesheet href=../../assets/stylesheets/main.19753c6b.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.196e0c26.min.css><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-151208281-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-scheme data-md-color-primary=none data-md-color-accent=none> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#mergeintocommand class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid" aria-label=Header> <a href=https://books.japila.pl/delta-lake-internals/ title="The Internals of Delta Lake" class="md-header-nav__button md-logo" aria-label="The Internals of Delta Lake"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 2l-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5z"/></svg> </a> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <span class="md-header-nav__topic md-ellipsis"> The Internals of Delta Lake </span> <span class="md-header-nav__topic md-ellipsis"> MergeIntoCommand </span> </div> </div> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header-nav__source> <a href=https://github.com/japila-books/delta-lake-internals/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> delta-lake-internals </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class="md-tabs md-tabs--active" aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../sql/ class=md-tabs__link> Delta SQL </a> </li> <li class=md-tabs__item> <a href=../DeltaCommand/ class="md-tabs__link md-tabs__link--active"> Commands </a> </li> <li class=md-tabs__item> <a href=../../demo/merge-operation/ class=md-tabs__link> Demos </a> </li> <li class=md-tabs__item> <a href=../../DeltaErrors/ class=md-tabs__link> Misc </a> </li> <li class=md-tabs__item> <a href=../../contenders/ class=md-tabs__link> Contenders </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://books.japila.pl/delta-lake-internals/ title="The Internals of Delta Lake" class="md-nav__button md-logo" aria-label="The Internals of Delta Lake"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 2l-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5z"/></svg> </a> The Internals of Delta Lake </label> <div class=md-nav__source> <a href=https://github.com/japila-books/delta-lake-internals/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> delta-lake-internals </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <label class=md-nav__link for=nav-1> Home <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Home data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Welcome </a> </li> <li class=md-nav__item> <a href=../../overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../installation/ class=md-nav__link> Installation </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-4 type=checkbox id=nav-1-4> <label class=md-nav__link for=nav-1-4> Time Travel <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Time Travel" data-md-level=2> <label class=md-nav__title for=nav-1-4> <span class="md-nav__icon md-icon"></span> Time Travel </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../time-travel/ class=md-nav__link> Time Travel </a> </li> <li class=md-nav__item> <a href=../../DeltaTimeTravelSpec/ class=md-nav__link> DeltaTimeTravelSpec </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../DeltaTable/ class=md-nav__link> DeltaTable </a> </li> <li class=md-nav__item> <a href=../../DeltaSQLConf/ class=md-nav__link> Configuration Properties </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-7 type=checkbox id=nav-1-7> <label class=md-nav__link for=nav-1-7> Transaction Log (DeltaLog) <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Transaction Log (DeltaLog)" data-md-level=2> <label class=md-nav__title for=nav-1-7> <span class="md-nav__icon md-icon"></span> Transaction Log (DeltaLog) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../DeltaLog/ class=md-nav__link> DeltaLog </a> </li> <li class=md-nav__item> <a href=../../Operation/ class=md-nav__link> Operation </a> </li> <li class=md-nav__item> <a href=../../Checkpoints/ class=md-nav__link> Checkpoints </a> </li> <li class=md-nav__item> <a href=../../SnapshotManagement/ class=md-nav__link> SnapshotManagement </a> </li> <li class=md-nav__item> <a href=../../ReadChecksum/ class=md-nav__link> ReadChecksum </a> </li> <li class=md-nav__item> <a href=../../MetadataCleanup/ class=md-nav__link> MetadataCleanup </a> </li> <li class=md-nav__item> <a href=../../LogStoreProvider/ class=md-nav__link> LogStoreProvider </a> </li> <li class=md-nav__item> <a href=../../VerifyChecksum/ class=md-nav__link> VerifyChecksum </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-8 type=checkbox id=nav-1-8> <label class=md-nav__link for=nav-1-8> State Snapshot <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="State Snapshot" data-md-level=2> <label class=md-nav__title for=nav-1-8> <span class="md-nav__icon md-icon"></span> State Snapshot </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Snapshot/ class=md-nav__link> Snapshot </a> </li> <li class=md-nav__item> <a href=../../InMemoryLogReplay/ class=md-nav__link> InMemoryLogReplay </a> </li> <li class=md-nav__item> <a href=../../PartitionFiltering/ class=md-nav__link> PartitionFiltering </a> </li> <li class=md-nav__item> <a href=../../DeltaFileFormat/ class=md-nav__link> DeltaFileFormat </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-9 type=checkbox id=nav-1-9> <label class=md-nav__link for=nav-1-9> OptimisticTransaction <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=OptimisticTransaction data-md-level=2> <label class=md-nav__title for=nav-1-9> <span class="md-nav__icon md-icon"></span> OptimisticTransaction </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../OptimisticTransaction/ class=md-nav__link> OptimisticTransaction </a> </li> <li class=md-nav__item> <a href=../../TransactionalWrite/ class=md-nav__link> TransactionalWrite </a> </li> <li class=md-nav__item> <a href=../../DelayedCommitProtocol/ class=md-nav__link> DelayedCommitProtocol </a> </li> <li class=md-nav__item> <a href=../../PostCommitHook/ class=md-nav__link> Post-Commit Hooks </a> </li> <li class=md-nav__item> <a href=../../OptimisticTransactionImpl/ class=md-nav__link> OptimisticTransactionImpl </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-10 type=checkbox id=nav-1-10> <label class=md-nav__link for=nav-1-10> LogStore <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=LogStore data-md-level=2> <label class=md-nav__title for=nav-1-10> <span class="md-nav__icon md-icon"></span> LogStore </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../LogStore/ class=md-nav__link> LogStore </a> </li> <li class=md-nav__item> <a href=../../HDFSLogStore/ class=md-nav__link> HDFSLogStore </a> </li> <li class=md-nav__item> <a href=../../HadoopFileSystemLogStore/ class=md-nav__link> HadoopFileSystemLogStore </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../DeltaHistoryManager/ class=md-nav__link> DeltaHistoryManager </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-12 type=checkbox id=nav-1-12> <label class=md-nav__link for=nav-1-12> Actions <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Actions data-md-level=2> <label class=md-nav__title for=nav-1-12> <span class="md-nav__icon md-icon"></span> Actions </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Action/ class=md-nav__link> Action </a> </li> <li class=md-nav__item> <a href=../../AddFile/ class=md-nav__link> AddFile </a> </li> <li class=md-nav__item> <a href=../../CommitInfo/ class=md-nav__link> CommitInfo </a> </li> <li class=md-nav__item> <a href=../../FileAction/ class=md-nav__link> FileAction </a> </li> <li class=md-nav__item> <a href=../../Metadata/ class=md-nav__link> Metadata </a> </li> <li class=md-nav__item> <a href=../../Protocol/ class=md-nav__link> Protocol </a> </li> <li class=md-nav__item> <a href=../../RemoveFile/ class=md-nav__link> RemoveFile </a> </li> <li class=md-nav__item> <a href=../../SetTransaction/ class=md-nav__link> SetTransaction </a> </li> <li class=md-nav__item> <a href=../../SingleAction/ class=md-nav__link> SingleAction </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-13 type=checkbox id=nav-1-13> <label class=md-nav__link for=nav-1-13> DeltaConfigs <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=DeltaConfigs data-md-level=2> <label class=md-nav__title for=nav-1-13> <span class="md-nav__icon md-icon"></span> DeltaConfigs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../DeltaConfigs/ class=md-nav__link> DeltaConfigs </a> </li> <li class=md-nav__item> <a href=../../DeltaConfig/ class=md-nav__link> DeltaConfig </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../FileNames/ class=md-nav__link> FileNames </a> </li> <li class=md-nav__item> <a href=../../spark-logging/ class=md-nav__link> Logging </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-16 type=checkbox id=nav-1-16> <label class=md-nav__link for=nav-1-16> Delta Data Source <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Delta Data Source" data-md-level=2> <label class=md-nav__title for=nav-1-16> <span class="md-nav__icon md-icon"></span> Delta Data Source </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../DeltaDataSource/ class=md-nav__link> DeltaDataSource </a> </li> <li class=md-nav__item> <a href=../../DeltaOptions/ class=md-nav__link> DeltaOptions </a> </li> <li class=md-nav__item> <a href=../../DeltaWriteOptions/ class=md-nav__link> DeltaWriteOptions </a> </li> <li class=md-nav__item> <a href=../../DeltaReadOptions/ class=md-nav__link> DeltaReadOptions </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-16-5 type=checkbox id=nav-1-16-5> <label class=md-nav__link for=nav-1-16-5> DeltaSource <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=DeltaSource data-md-level=3> <label class=md-nav__title for=nav-1-16-5> <span class="md-nav__icon md-icon"></span> DeltaSource </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../DeltaSource/ class=md-nav__link> DeltaSource </a> </li> <li class=md-nav__item> <a href=../../DeltaSourceOffset/ class=md-nav__link> DeltaSourceOffset </a> </li> <li class=md-nav__item> <a href=../../SnapshotIterator/ class=md-nav__link> SnapshotIterator </a> </li> <li class=md-nav__item> <a href=../../DeltaSourceSnapshot/ class=md-nav__link> DeltaSourceSnapshot </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../DeltaSink/ class=md-nav__link> DeltaSink </a> </li> <li class=md-nav__item> <a href=../../WriteIntoDeltaBuilder/ class=md-nav__link> WriteIntoDeltaBuilder </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-17 type=checkbox id=nav-1-17> <label class=md-nav__link for=nav-1-17> Spark SQL Extensions <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Spark SQL Extensions" data-md-level=2> <label class=md-nav__title for=nav-1-17> <span class="md-nav__icon md-icon"></span> Spark SQL Extensions </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../DeltaCatalog/ class=md-nav__link> DeltaCatalog </a> </li> <li class=md-nav__item> <a href=../../DeltaTableV2/ class=md-nav__link> DeltaTableV2 </a> </li> <li class=md-nav__item> <a href=../../StagedDeltaTableV2/ class=md-nav__link> StagedDeltaTableV2 </a> </li> <li class=md-nav__item> <a href=../../DeltaSparkSessionExtension/ class=md-nav__link> DeltaSparkSessionExtension </a> </li> <li class=md-nav__item> <a href=../../DeltaAnalysis/ class=md-nav__link> DeltaAnalysis </a> </li> <li class=md-nav__item> <a href=../../DeltaUnsupportedOperationsCheck/ class=md-nav__link> DeltaUnsupportedOperationsCheck </a> </li> <li class=md-nav__item> <a href=../../PreprocessTableDelete/ class=md-nav__link> PreprocessTableDelete </a> </li> <li class=md-nav__item> <a href=../../PreprocessTableMerge/ class=md-nav__link> PreprocessTableMerge </a> </li> <li class=md-nav__item> <a href=../../PreprocessTableUpdate/ class=md-nav__link> PreprocessTableUpdate </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../SQLMetricsReporting/ class=md-nav__link> SQLMetricsReporting </a> </li> <li class=md-nav__item> <a href=../../DeltaConvert/ class=md-nav__link> DeltaConvert </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-20 type=checkbox id=nav-1-20> <label class=md-nav__link for=nav-1-20> File Indices <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="File Indices" data-md-level=2> <label class=md-nav__title for=nav-1-20> <span class="md-nav__icon md-icon"></span> File Indices </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../TahoeFileIndex/ class=md-nav__link> TahoeFileIndex </a> </li> <li class=md-nav__item> <a href=../../TahoeBatchFileIndex/ class=md-nav__link> TahoeBatchFileIndex </a> </li> <li class=md-nav__item> <a href=../../TahoeLogFileIndex/ class=md-nav__link> TahoeLogFileIndex </a> </li> <li class=md-nav__item> <a href=../../DeltaLogFileIndex/ class=md-nav__link> DeltaLogFileIndex </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class=md-nav__link for=nav-2> Delta SQL <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Delta SQL" data-md-level=1> <label class=md-nav__title for=nav-2> <span class="md-nav__icon md-icon"></span> Delta SQL </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../sql/ class=md-nav__link> Delta SQL </a> </li> <li class=md-nav__item> <a href=../../sql/DeltaSqlParser/ class=md-nav__link> DeltaSqlParser </a> </li> <li class=md-nav__item> <a href=../../sql/DeltaSqlAstBuilder/ class=md-nav__link> DeltaSqlAstBuilder </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3 type=checkbox id=nav-3 checked> <label class=md-nav__link for=nav-3> Commands <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Commands data-md-level=1> <label class=md-nav__title for=nav-3> <span class="md-nav__icon md-icon"></span> Commands </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../DeltaCommand/ class=md-nav__link> DeltaCommand </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-2 type=checkbox id=nav-3-2> <label class=md-nav__link for=nav-3-2> Alter Table <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Alter Table" data-md-level=2> <label class=md-nav__title for=nav-3-2> <span class="md-nav__icon md-icon"></span> Alter Table </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../AlterDeltaTableCommand/ class=md-nav__link> AlterDeltaTableCommand </a> </li> <li class=md-nav__item> <a href=../AlterTableAddColumnsDeltaCommand/ class=md-nav__link> AlterTableAddColumnsDeltaCommand </a> </li> <li class=md-nav__item> <a href=../AlterTableChangeColumnDeltaCommand/ class=md-nav__link> AlterTableChangeColumnDeltaCommand </a> </li> <li class=md-nav__item> <a href=../AlterTableReplaceColumnsDeltaCommand/ class=md-nav__link> AlterTableReplaceColumnsDeltaCommand </a> </li> <li class=md-nav__item> <a href=../AlterTableSetLocationDeltaCommand/ class=md-nav__link> AlterTableSetLocationDeltaCommand </a> </li> <li class=md-nav__item> <a href=../AlterTableSetPropertiesDeltaCommand/ class=md-nav__link> AlterTableSetPropertiesDeltaCommand </a> </li> <li class=md-nav__item> <a href=../AlterTableUnsetPropertiesDeltaCommand/ class=md-nav__link> AlterTableUnsetPropertiesDeltaCommand </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../ConvertToDeltaCommand/ class=md-nav__link> ConvertToDeltaCommand </a> </li> <li class=md-nav__item> <a href=../CreateDeltaTableCommand/ class=md-nav__link> CreateDeltaTableCommand </a> </li> <li class=md-nav__item> <a href=../DeleteCommand/ class=md-nav__link> DeleteCommand </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-6 type=checkbox id=nav-3-6> <label class=md-nav__link for=nav-3-6> DeltaGenerateCommand <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=DeltaGenerateCommand data-md-level=2> <label class=md-nav__title for=nav-3-6> <span class="md-nav__icon md-icon"></span> DeltaGenerateCommand </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../DeltaGenerateCommand/ class=md-nav__link> DeltaGenerateCommand </a> </li> <li class=md-nav__item> <a href=../../DeltaGenerateCommandBase/ class=md-nav__link> DeltaGenerateCommandBase </a> </li> <li class=md-nav__item> <a href=../../GenerateSymlinkManifest/ class=md-nav__link> GenerateSymlinkManifest </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../DescribeDeltaDetailCommand/ class=md-nav__link> DescribeDeltaDetailCommand </a> </li> <li class=md-nav__item> <a href=../DescribeDeltaHistoryCommand/ class=md-nav__link> DescribeDeltaHistoryCommand </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-9 type=checkbox id=nav-3-9 checked> <label class=md-nav__link for=nav-3-9> Merge <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Merge data-md-level=2> <label class=md-nav__title for=nav-3-9> <span class="md-nav__icon md-icon"></span> Merge </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../DeltaMergeBuilder/ class=md-nav__link> DeltaMergeBuilder </a> </li> <li class=md-nav__item> <a href=../DeltaMergeMatchedActionBuilder/ class=md-nav__link> DeltaMergeMatchedActionBuilder </a> </li> <li class=md-nav__item> <a href=../DeltaMergeNotMatchedActionBuilder/ class=md-nav__link> DeltaMergeNotMatchedActionBuilder </a> </li> <li class=md-nav__item> <a href=../DeltaMergeIntoClause/ class=md-nav__link> DeltaMergeIntoClause </a> </li> <li class=md-nav__item> <a href=../DeltaMergeInto/ class=md-nav__link> DeltaMergeInto </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> MergeIntoCommand <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> MergeIntoCommand </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#performance-metrics class=md-nav__link> Performance Metrics </a> <nav class=md-nav aria-label="Performance Metrics"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#number-of-target-rows-rewritten-unmodified class=md-nav__link> number of target rows rewritten unmodified </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#creating-instance class=md-nav__link> Creating Instance </a> </li> <li class=md-nav__item> <a href=#source-data-to-merge-from class=md-nav__link> Source Data (to Merge From) </a> </li> <li class=md-nav__item> <a href=#target-deltalog class=md-nav__link> Target DeltaLog </a> </li> <li class=md-nav__item> <a href=#executing-command class=md-nav__link> Executing Command </a> <nav class=md-nav aria-label=" Executing Command"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#finding-files-to-rewrite class=md-nav__link> Finding Files to Rewrite </a> </li> <li class=md-nav__item> <a href=#writing-all-changes class=md-nav__link> Writing All Changes </a> </li> <li class=md-nav__item> <a href=#building-target-logical-query-plan-for-addfiles class=md-nav__link> Building Target Logical Query Plan for AddFiles </a> </li> <li class=md-nav__item> <a href=#writeinsertsonlywhennomatchedclauses class=md-nav__link> writeInsertsOnlyWhenNoMatchedClauses </a> </li> <li class=md-nav__item> <a href=#exceptions class=md-nav__link> Exceptions </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#logging class=md-nav__link> Logging </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../JoinedRowProcessor/ class=md-nav__link> JoinedRowProcessor </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../UpdateCommand/ class=md-nav__link> UpdateCommand </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-11 type=checkbox id=nav-3-11> <label class=md-nav__link for=nav-3-11> Vacuum <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Vacuum data-md-level=2> <label class=md-nav__title for=nav-3-11> <span class="md-nav__icon md-icon"></span> Vacuum </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../vacuum/ class=md-nav__link> Vacuum </a> </li> <li class=md-nav__item> <a href=../VacuumCommand/ class=md-nav__link> VacuumCommand </a> </li> <li class=md-nav__item> <a href=../VacuumCommandImpl/ class=md-nav__link> VacuumCommandImpl </a> </li> <li class=md-nav__item> <a href=../VacuumTableCommand/ class=md-nav__link> VacuumTableCommand </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../WriteIntoDelta/ class=md-nav__link> WriteIntoDelta </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Demos <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Demos data-md-level=1> <label class=md-nav__title for=nav-4> <span class="md-nav__icon md-icon"></span> Demos </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../demo/merge-operation/ class=md-nav__link> Merge Operation </a> </li> <li class=md-nav__item> <a href=../../demo/Converting-Parquet-Dataset-Into-Delta-Format/ class=md-nav__link> Converting Parquet Dataset Into Delta Format </a> </li> <li class=md-nav__item> <a href=../../demo/stream-processing-of-delta-table/ class=md-nav__link> Stream Processing of Delta Table </a> </li> <li class=md-nav__item> <a href=../../demo/Using-Delta-Lake-as-Streaming-Sink-in-Structured-Streaming/ class=md-nav__link> Using Delta Lake as Streaming Sink in Structured Streaming </a> </li> <li class=md-nav__item> <a href=../../demo/Debugging-Delta-Lake-Using-IntelliJ-IDEA/ class=md-nav__link> Debugging Delta Lake Using IntelliJ IDEA </a> </li> <li class=md-nav__item> <a href=../../demo/Observing-Transaction-Retries/ class=md-nav__link> Observing Transaction Retries </a> </li> <li class=md-nav__item> <a href=../../demo/DeltaTable-DeltaLog-And-Snapshots/ class=md-nav__link> DeltaTable, DeltaLog And Snapshots </a> </li> <li class=md-nav__item> <a href=../../demo/schema-evolution/ class=md-nav__link> Schema Evolution </a> </li> <li class=md-nav__item> <a href=../../demo/user-metadata-for-labelling-commits/ class=md-nav__link> User Metadata for Labelling Commits </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Misc <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Misc data-md-level=1> <label class=md-nav__title for=nav-5> <span class="md-nav__icon md-icon"></span> Misc </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../DeltaErrors/ class=md-nav__link> DeltaErrors </a> </li> <li class=md-nav__item> <a href=../../DeltaFileOperations/ class=md-nav__link> DeltaFileOperations </a> </li> <li class=md-nav__item> <a href=../../DeltaInvariantCheckerExec/ class=md-nav__link> DeltaInvariantCheckerExec </a> </li> <li class=md-nav__item> <a href=../../DeltaTableOperations/ class=md-nav__link> DeltaTableOperations </a> </li> <li class=md-nav__item> <a href=../../DeltaTableUtils/ class=md-nav__link> DeltaTableUtils </a> </li> <li class=md-nav__item> <a href=../../ImplicitMetadataOperation/ class=md-nav__link> ImplicitMetadataOperation </a> </li> <li class=md-nav__item> <a href=../../Invariants/ class=md-nav__link> Invariants </a> </li> <li class=md-nav__item> <a href=../../SchemaUtils/ class=md-nav__link> SchemaUtils </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5-9 type=checkbox id=nav-5-9> <label class=md-nav__link for=nav-5-9> StateCache <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=StateCache data-md-level=2> <label class=md-nav__title for=nav-5-9> <span class="md-nav__icon md-icon"></span> StateCache </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../StateCache/ class=md-nav__link> StateCache </a> </li> <li class=md-nav__item> <a href=../../CachedDS/ class=md-nav__link> CachedDS </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6 type=checkbox id=nav-6> <label class=md-nav__link for=nav-6> Contenders <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Contenders data-md-level=1> <label class=md-nav__title for=nav-6> <span class="md-nav__icon md-icon"></span> Contenders </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../contenders/ class=md-nav__link> Contenders </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#performance-metrics class=md-nav__link> Performance Metrics </a> <nav class=md-nav aria-label="Performance Metrics"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#number-of-target-rows-rewritten-unmodified class=md-nav__link> number of target rows rewritten unmodified </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#creating-instance class=md-nav__link> Creating Instance </a> </li> <li class=md-nav__item> <a href=#source-data-to-merge-from class=md-nav__link> Source Data (to Merge From) </a> </li> <li class=md-nav__item> <a href=#target-deltalog class=md-nav__link> Target DeltaLog </a> </li> <li class=md-nav__item> <a href=#executing-command class=md-nav__link> Executing Command </a> <nav class=md-nav aria-label=" Executing Command"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#finding-files-to-rewrite class=md-nav__link> Finding Files to Rewrite </a> </li> <li class=md-nav__item> <a href=#writing-all-changes class=md-nav__link> Writing All Changes </a> </li> <li class=md-nav__item> <a href=#building-target-logical-query-plan-for-addfiles class=md-nav__link> Building Target Logical Query Plan for AddFiles </a> </li> <li class=md-nav__item> <a href=#writeinsertsonlywhennomatchedclauses class=md-nav__link> writeInsertsOnlyWhenNoMatchedClauses </a> </li> <li class=md-nav__item> <a href=#exceptions class=md-nav__link> Exceptions </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#logging class=md-nav__link> Logging </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/japila-books/delta-lake-internals/edit/master/docs/commands/MergeIntoCommand.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1 id=mergeintocommand>MergeIntoCommand<a class=headerlink href=#mergeintocommand title="Permanent link">&para;</a></h1> <p><code>MergeIntoCommand</code> is a <a href=../DeltaCommand/ >DeltaCommand</a> that represents a <a href=../DeltaMergeInto/ >DeltaMergeInto</a> logical command at execution time.</p> <p><code>MergeIntoCommand</code> is a logical command (Spark SQL's <a href=https://jaceklaskowski.github.io/mastering-spark-sql-book/logical-operators/RunnableCommand/ >RunnableCommand</a>).</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Learn more on the internals of <code>MergeIntoCommand</code> in <a href=../../demo/merge-operation/ >Demo: Merge Operation</a>.</p> </div> <h2 id=performance-metrics>Performance Metrics<a class=headerlink href=#performance-metrics title="Permanent link">&para;</a></h2> <table> <thead> <tr> <th>Name</th> <th>web UI</th> </tr> </thead> <tbody> <tr> <td><code>numSourceRows</code></td> <td>number of source rows</td> </tr> <tr> <td><a href=#numTargetRowsCopied>numTargetRowsCopied</a></td> <td>number of target rows rewritten unmodified</td> </tr> <tr> <td><code>numTargetRowsInserted</code></td> <td>number of inserted rows</td> </tr> <tr> <td><code>numTargetRowsUpdated</code></td> <td>number of updated rows</td> </tr> <tr> <td><code>numTargetRowsDeleted</code></td> <td>number of deleted rows</td> </tr> <tr> <td><span id=numTargetFilesBeforeSkipping> <code>numTargetFilesBeforeSkipping</code></td> <td>number of target files before skipping</td> </tr> <tr> <td><span id=numTargetFilesAfterSkipping> <code>numTargetFilesAfterSkipping</code></td> <td>number of target files after skipping</td> </tr> <tr> <td><span id=numTargetFilesRemoved> <code>numTargetFilesRemoved</code></td> <td>number of files removed to target</td> </tr> <tr> <td><code>numTargetFilesAdded</code></td> <td>number of files added to target</td> </tr> </tbody> </table> <h3 id=number-of-target-rows-rewritten-unmodified><span id=numTargetRowsCopied> number of target rows rewritten unmodified<a class=headerlink href=#number-of-target-rows-rewritten-unmodified title="Permanent link">&para;</a></h3> <p><code>numTargetRowsCopied</code> performance metric (like the other <a href=#performance-metrics>metrics</a>) is turned into a non-deterministic user-defined function (UDF).</p> <p><code>numTargetRowsCopied</code> becomes <code>incrNoopCountExpr</code> UDF.</p> <p><code>incrNoopCountExpr</code> UDF is resolved on a joined plan and used to create a <a href=../JoinedRowProcessor/#noopCopyOutput>JoinedRowProcessor</a> for <a href=#processPartition>processing partitions</a> of the joined plan <code>Dataset</code>.</p> <h2 id=creating-instance>Creating Instance<a class=headerlink href=#creating-instance title="Permanent link">&para;</a></h2> <p><code>MergeIntoCommand</code> takes the following to be created:</p> <ul> <li><a href=#source>Source Data</a></li> <li><span id=target> Target Data (<code>LogicalPlan</code>)</li> <li><span id=targetFileIndex> <a href=../../TahoeFileIndex/ >TahoeFileIndex</a></li> <li><span id=condition> Condition Expression</li> <li><span id=matchedClauses> Matched Clauses (<code>Seq[DeltaMergeIntoMatchedClause]</code>)</li> <li><span id=notMatchedClause> Optional Non-Matched Clause (<code>Option[DeltaMergeIntoInsertClause]</code>)</li> <li><span id=migratedSchema> Migrated Schema</li> </ul> <p><code>MergeIntoCommand</code> is created when <a href=../../PreprocessTableMerge/ >PreprocessTableMerge</a> logical resolution rule is executed (on a <a href=../DeltaMergeInto/ >DeltaMergeInto</a> logical command).</p> <h2 id=source-data-to-merge-from><span id=source> Source Data (to Merge From)<a class=headerlink href=#source-data-to-merge-from title="Permanent link">&para;</a></h2> <p>When <a href=#creating-instance>created</a>, <code>MergeIntoCommand</code> is given a <code>LogicalPlan</code> for the source data to merge from (referred to internally as <em>source</em>).</p> <p>The source <code>LogicalPlan</code> is used twice:</p> <ul> <li>Firstly, in one of the following:<ul> <li>An inner join (in <a href=#findTouchedFiles>findTouchedFiles</a>) that is <code>count</code> in web UI</li> <li>A leftanti join (in <a href=#writeInsertsOnlyWhenNoMatchedClauses>writeInsertsOnlyWhenNoMatchedClauses</a>)</li> </ul> </li> <li>Secondly, in rightOuter or fullOuter join (in <a href=#writeAllChanges>writeAllChanges</a>)</li> </ul> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Enable <code>DEBUG</code> logging level for <a href=#logging>org.apache.spark.sql.delta.commands.MergeIntoCommand</a> logger to see the inner-workings of <a href=#writeAllChanges>writeAllChanges</a>.</p> </div> <h2 id=target-deltalog><span id=targetDeltaLog> Target DeltaLog<a class=headerlink href=#target-deltalog title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><span class=n>targetDeltaLog</span><span class=k>:</span> <span class=kt>DeltaLog</span>
</code></pre></div> <p><code>targetDeltaLog</code> is the <a href=../../TahoeFileIndex/#deltaLog>DeltaLog</a> of the <a href=#targetFileIndex>TahoeFileIndex</a>.</p> <p><code>targetDeltaLog</code> is used for the following:</p> <ul> <li><a href=../../DeltaLog/#withNewTransaction>Start a new transaction</a> when <a href=#run>executed</a></li> <li>To access the <a href=../../DeltaLog/#dataPath>Data Path</a> when <a href=#findTouchedFiles>finding files to rewrite</a></li> </ul> <details class=note><summary>Lazy Value</summary></details> <p><code>targetDeltaLog</code> is a Scala <strong>lazy value</strong> to guarantee that the code to initialize it is executed once only (when accessed for the first time) and cached afterwards.</p> <h2 id=executing-command><span id=run> Executing Command<a class=headerlink href=#executing-command title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><span class=n>run</span><span class=o>(</span>
  <span class=n>spark</span><span class=k>:</span> <span class=kt>SparkSession</span><span class=o>)</span><span class=k>:</span> <span class=kt>Seq</span><span class=o>[</span><span class=kt>Row</span><span class=o>]</span>
</code></pre></div> <p><code>run</code> is part of the <code>RunnableCommand</code> (<a href=https://jaceklaskowski.github.io/mastering-spark-sql-book/logical-operators/RunnableCommand/ >Spark SQL</a>) abstraction.</p> <p><code>run</code> requests the <a href=#targetDeltaLog>target DeltaLog</a> to <a href=../../DeltaLog/#withNewTransaction>start a new transaction</a>.</p> <p>With <a href=../../DeltaSQLConf/#DELTA_SCHEMA_AUTO_MIGRATE>spark.databricks.delta.schema.autoMerge.enabled</a> configuration property enabled, <code>run</code> <a href=../../ImplicitMetadataOperation/#updateMetadata>updates the metadata</a> (of the transaction).</p> <p><span id=run-deltaActions> <code>run</code> determines Delta actions (<a href=../../RemoveFile/ >RemoveFile</a>s and <a href=../../AddFile/ >AddFile</a>s).</p> <div class="admonition todo"> <p class=admonition-title>Describe <code>deltaActions</code> part</p> </div> <p>With <a href=../../DeltaSQLConf/#DELTA_HISTORY_METRICS_ENABLED>spark.databricks.delta.history.metricsEnabled</a> configuration property enabled, <code>run</code> requests the <a href=../../OptimisticTransaction/ >current transaction</a> to <a href=../../SQLMetricsReporting/#registerSQLMetrics>register SQL metrics for the Delta operation</a>.</p> <p><code>run</code> requests the <a href=../../OptimisticTransaction/ >current transaction</a> to <a href=../../OptimisticTransactionImpl/#commit>commit</a> (with the <a href=#run-deltaActions>Delta actions</a> and <code>Merge</code> operation).</p> <p><code>run</code> records the Delta event.</p> <p><code>run</code> posts a <code>SparkListenerDriverAccumUpdates</code> Spark event (with the metrics).</p> <p>In the end, <code>run</code> requests the <code>CacheManager</code> to <code>recacheByPlan</code>.</p> <h3 id=finding-files-to-rewrite><span id=findTouchedFiles> Finding Files to Rewrite<a class=headerlink href=#finding-files-to-rewrite title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=n>findTouchedFiles</span><span class=o>(</span>
  <span class=n>spark</span><span class=k>:</span> <span class=kt>SparkSession</span><span class=o>,</span>
  <span class=n>deltaTxn</span><span class=k>:</span> <span class=kt>OptimisticTransaction</span><span class=o>)</span><span class=k>:</span> <span class=kt>Seq</span><span class=o>[</span><span class=kt>AddFile</span><span class=o>]</span>
</code></pre></div> <div class="admonition important"> <p class=admonition-title>Important</p> <p><code>findTouchedFiles</code> is such a fine piece of art (<em>a gem</em>). It uses a custom accumulator, a UDF (to use this accumulator to record touched file names) and <code>input_file_name()</code> standard function for the names of the files read.</p> <p>It is always worth keeping in mind that Delta Lake uses files for data storage and that is why <code>input_file_name()</code> standard function works. It would not work for non-file-based data sources.</p> </div> <details class=note><summary>Example 1: Understanding the Internals of <code>findTouchedFiles</code></summary><p>The following query writes out a 10-element dataset using the default parquet data source to <code>/tmp/parquet</code> directory:</p> <div class=highlight><pre><span></span><code><span class=k>val</span> <span class=n>target</span> <span class=o>=</span> <span class=s>&quot;/tmp/parquet&quot;</span>
<span class=n>spark</span><span class=o>.</span><span class=n>range</span><span class=o>(</span><span class=mi>10</span><span class=o>).</span><span class=n>write</span><span class=o>.</span><span class=n>save</span><span class=o>(</span><span class=n>target</span><span class=o>)</span>
</code></pre></div> <p>The number of parquet part files varies based on the number of partitions (CPU cores).</p> <p>The following query loads the parquet dataset back alongside <code>input_file_name()</code> standard function to mimic <code>findTouchedFiles</code>'s behaviour.</p> <div class=highlight><pre><span></span><code><span class=k>val</span> <span class=nc>FILE_NAME_COL</span> <span class=o>=</span> <span class=s>&quot;_file_name_&quot;</span>
<span class=k>val</span> <span class=n>dataFiles</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>read</span><span class=o>.</span><span class=n>parquet</span><span class=o>(</span><span class=n>target</span><span class=o>).</span><span class=n>withColumn</span><span class=o>(</span><span class=nc>FILE_NAME_COL</span><span class=o>,</span> <span class=n>input_file_name</span><span class=o>())</span>
</code></pre></div> <div class=highlight><pre><span></span><code>scala&gt; dataFiles.show(truncate = false)
+---+---------------------------------------------------------------------------------------+
|id |_file_name_                                                                            |
+---+---------------------------------------------------------------------------------------+
|4  |file:///tmp/parquet/part-00007-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|
|0  |file:///tmp/parquet/part-00001-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|
|3  |file:///tmp/parquet/part-00006-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|
|6  |file:///tmp/parquet/part-00011-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|
|1  |file:///tmp/parquet/part-00003-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|
|8  |file:///tmp/parquet/part-00014-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|
|2  |file:///tmp/parquet/part-00004-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|
|7  |file:///tmp/parquet/part-00012-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|
|5  |file:///tmp/parquet/part-00009-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|
|9  |file:///tmp/parquet/part-00015-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|
+---+---------------------------------------------------------------------------------------+
</code></pre></div> <p>As you may have thought, not all part files have got data and so they are not included in the dataset. That is when <code>findTouchedFiles</code> uses <code>groupBy</code> operator and <code>count</code> action to calculate match frequency.</p> <div class=highlight><pre><span></span><code>val counts = dataFiles.groupBy(FILE_NAME_COL).count()
scala&gt; counts.show(truncate = false)
+---------------------------------------------------------------------------------------+-----+
|_file_name_                                                                            |count|
+---------------------------------------------------------------------------------------+-----+
|file:///tmp/parquet/part-00015-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1    |
|file:///tmp/parquet/part-00007-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1    |
|file:///tmp/parquet/part-00003-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1    |
|file:///tmp/parquet/part-00011-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1    |
|file:///tmp/parquet/part-00012-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1    |
|file:///tmp/parquet/part-00006-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1    |
|file:///tmp/parquet/part-00001-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1    |
|file:///tmp/parquet/part-00004-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1    |
|file:///tmp/parquet/part-00009-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1    |
|file:///tmp/parquet/part-00014-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1    |
+---------------------------------------------------------------------------------------+-----+
</code></pre></div> <p>Let's load all the part files in the <code>/tmp/parquet</code> directory and find which file(s) have no data.</p> <div class=highlight><pre><span></span><code><span class=k>import</span> <span class=nn>scala.sys.process._</span>
<span class=k>val</span> <span class=n>cmd</span> <span class=o>=</span> <span class=o>(</span><span class=s>s&quot;ls </span><span class=si>$target</span><span class=s>&quot;</span> <span class=o>#|</span> <span class=s>&quot;grep .parquet&quot;</span><span class=o>).</span><span class=n>lineStream</span>
<span class=k>val</span> <span class=n>allFiles</span> <span class=o>=</span> <span class=n>cmd</span><span class=o>.</span><span class=n>toArray</span><span class=o>.</span><span class=n>toSeq</span><span class=o>.</span><span class=n>toDF</span><span class=o>(</span><span class=nc>FILE_NAME_COL</span><span class=o>)</span>
  <span class=o>.</span><span class=n>select</span><span class=o>(</span><span class=n>concat</span><span class=o>(</span><span class=n>lit</span><span class=o>(</span><span class=s>s&quot;file://</span><span class=si>$target</span><span class=s>/&quot;</span><span class=o>),</span> <span class=n>col</span><span class=o>(</span><span class=nc>FILE_NAME_COL</span><span class=o>))</span> <span class=n>as</span> <span class=nc>FILE_NAME_COL</span><span class=o>)</span>
<span class=k>val</span> <span class=n>joinType</span> <span class=o>=</span> <span class=s>&quot;left_anti&quot;</span> <span class=c1>// MergeIntoCommand uses inner as it wants data file</span>
<span class=k>val</span> <span class=n>noDataFiles</span> <span class=o>=</span> <span class=n>allFiles</span><span class=o>.</span><span class=n>join</span><span class=o>(</span><span class=n>dataFiles</span><span class=o>,</span> <span class=nc>Seq</span><span class=o>(</span><span class=nc>FILE_NAME_COL</span><span class=o>),</span> <span class=n>joinType</span><span class=o>)</span>
</code></pre></div> <p>Mind that the data vs non-data datasets could be different, but that should not "interfere" with the main reasoning flow.</p> <div class=highlight><pre><span></span><code>scala&gt; noDataFiles.show(truncate = false)
+---------------------------------------------------------------------------------------+
|_file_name_                                                                            |
+---------------------------------------------------------------------------------------+
|file:///tmp/parquet/part-00000-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|
+---------------------------------------------------------------------------------------+
</code></pre></div> </details> <p><code>findTouchedFiles</code> registers an accumulator to collect all the distinct files that need to be rewritten (<em>touched files</em>).</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The name of the accumulator is <strong>internal.metrics.MergeIntoDelta.touchedFiles</strong> and <code>internal.metrics</code> part is supposed to hide it from web UI as potentially large (set of file names to be rewritten).</p> </div> <p><span id=findTouchedFiles-recordTouchedFileName> <code>findTouchedFiles</code> defines a nondeterministic UDF that adds the file names to the accumulator (<em>recordTouchedFileName</em>).</p> <p><span id=findTouchedFiles-dataSkippedFiles> <code>findTouchedFiles</code> splits conjunctive predicates (<code>And</code> binary expressions) in the <a href=#condition>condition</a> expression and collects the predicates that use the <a href=#target>target</a>'s columns (<em>targetOnlyPredicates</em>). <code>findTouchedFiles</code> requests the given <a href=../../OptimisticTransaction/ >OptimisticTransaction</a> for the <a href=../../OptimisticTransactionImpl/#filterFiles>files that match the target-only predicates</a> (and creates a <code>dataSkippedFiles</code> collection of <a href=../../AddFile/ >AddFile</a>s).</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>This step looks similar to <strong>filter predicate pushdown</strong>.</p> </div> <p><code>findTouchedFiles</code> creates one <code>DataFrame</code> for the <a href=#source>source data</a> (using <code>Dataset.ofRows</code> utility).</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Learn more about <a href=https://jaceklaskowski.github.io/mastering-spark-sql-book/Dataset/#ofRows>Dataset.ofRows</a> utility in <a href=https://jaceklaskowski.github.io/mastering-spark-sql-book>The Internals of Spark SQL</a> online book.</p> </div> <p><code>findTouchedFiles</code> <a href=#buildTargetPlanWithFiles>builds a logical query plan</a> for the files (matching the predicates) and creates another <code>DataFrame</code> for the target data. <code>findTouchedFiles</code> adds two columns to the target dataframe:</p> <ol> <li><code>_row_id_</code> for <code>monotonically_increasing_id()</code> standard function</li> <li><code>_file_name_</code> for <code>input_file_name()</code> standard function</li> </ol> <p><code>findTouchedFiles</code> creates (a <code>DataFrame</code> that is) an INNER JOIN of the source and target <code>DataFrame</code>s using the <a href=#condition>condition</a> expression.</p> <p><code>findTouchedFiles</code> takes the joined dataframe and selects <code>_row_id_</code> column and the <a href=#findTouchedFiles-recordTouchedFileName>recordTouchedFileName</a> UDF on the <code>_file_name_</code> column as <code>one</code>. The <code>DataFrame</code> is internally known as <code>collectTouchedFiles</code>.</p> <p><code>findTouchedFiles</code> uses <code>groupBy</code> operator on <code>_row_id_</code> to calculate a sum of all the values in the <code>one</code> column (as <code>count</code> column) in the two-column <code>collectTouchedFiles</code> dataset. The <code>DataFrame</code> is internally known as <code>matchedRowCounts</code>.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>No Spark job has been submitted yet. <code>findTouchedFiles</code> is still in "query preparation" mode.</p> </div> <p><code>findTouchedFiles</code> uses <code>filter</code> on the <code>count</code> column (in the <code>matchedRowCounts</code> dataset) with values greater than <code>1</code>. If there are any, <code>findTouchedFiles</code> throws an <code>UnsupportedOperationException</code> exception:</p> <div class=highlight><pre><span></span><code>Cannot perform MERGE as multiple source rows matched and attempted to update the same
target row in the Delta table. By SQL semantics of merge, when multiple source rows match
on the same target row, the update operation is ambiguous as it is unclear which source
should be used to update the matching target row.
You can preprocess the source table to eliminate the possibility of multiple matches.
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Since <code>findTouchedFiles</code> uses <code>count</code> action there should be a Spark SQL query reported (and possibly Spark jobs) in web UI.</p> </div> <p><code>findTouchedFiles</code> requests the <code>touchedFilesAccum</code> accumulator for the touched file names.</p> <details class=note><summary>Example 2: Understanding the Internals of <code>findTouchedFiles</code></summary><div class=highlight><pre><span></span><code><span class=k>val</span> <span class=nc>TOUCHED_FILES_ACCUM_NAME</span> <span class=o>=</span> <span class=s>&quot;MergeIntoDelta.touchedFiles&quot;</span>
<span class=k>val</span> <span class=n>touchedFilesAccum</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>sparkContext</span><span class=o>.</span><span class=n>collectionAccumulator</span><span class=o>[</span><span class=kt>String</span><span class=o>](</span><span class=nc>TOUCHED_FILES_ACCUM_NAME</span><span class=o>)</span>
<span class=k>val</span> <span class=n>recordTouchedFileName</span> <span class=o>=</span> <span class=n>udf</span> <span class=o>{</span> <span class=o>(</span><span class=n>fileName</span><span class=k>:</span> <span class=kt>String</span><span class=o>)</span> <span class=o>=&gt;</span> <span class=o>{</span>
  <span class=n>touchedFilesAccum</span><span class=o>.</span><span class=n>add</span><span class=o>(</span><span class=n>fileName</span><span class=o>)</span>
  <span class=mi>1</span>
<span class=o>}}.</span><span class=n>asNondeterministic</span><span class=o>()</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=k>val</span> <span class=n>target</span> <span class=o>=</span> <span class=s>&quot;/tmp/parquet&quot;</span>
<span class=n>spark</span><span class=o>.</span><span class=n>range</span><span class=o>(</span><span class=mi>10</span><span class=o>).</span><span class=n>write</span><span class=o>.</span><span class=n>save</span><span class=o>(</span><span class=n>target</span><span class=o>)</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=k>val</span> <span class=nc>FILE_NAME_COL</span> <span class=o>=</span> <span class=s>&quot;_file_name_&quot;</span>
<span class=k>val</span> <span class=n>dataFiles</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>read</span><span class=o>.</span><span class=n>parquet</span><span class=o>(</span><span class=n>target</span><span class=o>).</span><span class=n>withColumn</span><span class=o>(</span><span class=nc>FILE_NAME_COL</span><span class=o>,</span> <span class=n>input_file_name</span><span class=o>())</span>
<span class=k>val</span> <span class=n>collectTouchedFiles</span> <span class=o>=</span> <span class=n>dataFiles</span><span class=o>.</span><span class=n>select</span><span class=o>(</span><span class=n>col</span><span class=o>(</span><span class=nc>FILE_NAME_COL</span><span class=o>),</span> <span class=n>recordTouchedFileName</span><span class=o>(</span><span class=n>col</span><span class=o>(</span><span class=nc>FILE_NAME_COL</span><span class=o>)).</span><span class=n>as</span><span class=o>(</span><span class=s>&quot;one&quot;</span><span class=o>))</span>
</code></pre></div> <div class=highlight><pre><span></span><code>scala&gt; collectTouchedFiles.show(truncate = false)
+---------------------------------------------------------------------------------------+---+
|_file_name_                                                                            |one|
+---------------------------------------------------------------------------------------+---+
|file:///tmp/parquet/part-00007-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1  |
|file:///tmp/parquet/part-00001-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1  |
|file:///tmp/parquet/part-00006-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1  |
|file:///tmp/parquet/part-00011-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1  |
|file:///tmp/parquet/part-00003-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1  |
|file:///tmp/parquet/part-00014-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1  |
|file:///tmp/parquet/part-00004-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1  |
|file:///tmp/parquet/part-00012-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1  |
|file:///tmp/parquet/part-00009-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1  |
|file:///tmp/parquet/part-00015-76df546f-91f8-4cbb-8fcc-f51478e0db31-c000.snappy.parquet|1  |
+---------------------------------------------------------------------------------------+---+    
</code></pre></div> <div class=highlight><pre><span></span><code><span class=k>import</span> <span class=nn>scala.collection.JavaConverters._</span>
<span class=k>val</span> <span class=n>touchedFileNames</span> <span class=o>=</span> <span class=n>touchedFilesAccum</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>asScala</span><span class=o>.</span><span class=n>toSeq</span>
</code></pre></div> <p>Use the Stages tab in web UI to review the accumulator values.</p> </details> <p><code>findTouchedFiles</code> prints out the following TRACE message to the logs:</p> <div class=highlight><pre><span></span><code>findTouchedFiles: matched files:
  [touchedFileNames]
</code></pre></div> <p><code>findTouchedFiles</code> <a href=#generateCandidateFileMap>generateCandidateFileMap</a> for the <a href=#findTouchedFiles-dataSkippedFiles>files that match the target-only predicates</a>.</p> <p><code>findTouchedFiles</code> <a href=#getTouchedFile>getTouchedFile</a> for every touched file name.</p> <p><code>findTouchedFiles</code> updates the following performance metrics:</p> <ul> <li><a href=#numTargetFilesBeforeSkipping>numTargetFilesBeforeSkipping</a> and adds the <a href=#numOfFiles>numOfFiles</a> of the <a href=../../OptimisticTransaction/#snapshot>Snapshot</a> of the given <a href=../../OptimisticTransaction/ >OptimisticTransaction</a></li> <li><a href=#numTargetFilesAfterSkipping>numTargetFilesAfterSkipping</a> and adds the number of the <a href=#findTouchedFiles-dataSkippedFiles>files that match the target-only predicates</a></li> <li><a href=#numTargetFilesRemoved>numTargetFilesRemoved</a> and adds the number of the touched files</li> </ul> <p>In the end, <code>findTouchedFiles</code> gives the touched files (as <a href=../../AddFile/ >AddFile</a>s).</p> <h3 id=writing-all-changes><span id=writeAllChanges> Writing All Changes<a class=headerlink href=#writing-all-changes title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=n>writeAllChanges</span><span class=o>(</span>
  <span class=n>spark</span><span class=k>:</span> <span class=kt>SparkSession</span><span class=o>,</span>
  <span class=n>deltaTxn</span><span class=k>:</span> <span class=kt>OptimisticTransaction</span><span class=o>,</span>
  <span class=n>filesToRewrite</span><span class=k>:</span> <span class=kt>Seq</span><span class=o>[</span><span class=kt>AddFile</span><span class=o>])</span><span class=k>:</span> <span class=kt>Seq</span><span class=o>[</span><span class=kt>AddFile</span><span class=o>]</span>
</code></pre></div> <p><code>writeAllChanges</code> builds the target output columns (possibly with some <code>null</code>s for the target columns that are not in the current schema).</p> <p><span id=writeAllChanges-newTarget> <code>writeAllChanges</code> <a href=#buildTargetPlanWithFiles>builds a target logical query plan for the AddFiles</a>.</p> <p><span id=writeAllChanges-joinType> <code>writeAllChanges</code> determines a join type to use (<code>rightOuter</code> or <code>fullOuter</code>).</p> <p><code>writeAllChanges</code> prints out the following DEBUG message to the logs:</p> <div class=highlight><pre><span></span><code>writeAllChanges using [joinType] join:
source.output: [outputSet]
target.output: [outputSet]
condition: [condition]
newTarget.output: [outputSet]
</code></pre></div> <p><span id=writeAllChanges-joinedDF> <code>writeAllChanges</code> creates a <code>joinedDF</code> DataFrame that is a join of the DataFrames for the <a href=#source>source</a> and the new <a href=#writeAllChanges-newTarget>target</a> logical plans with the given <a href=#condition>join condition</a> and the <a href=#writeAllChanges-joinType>join type</a>.</p> <p><code>writeAllChanges</code> creates a <code>JoinedRowProcessor</code> that is then used to map over partitions of the <a href=#writeAllChanges-joinedDF>joined DataFrame</a>.</p> <p><code>writeAllChanges</code> prints out the following DEBUG message to the logs:</p> <div class=highlight><pre><span></span><code>writeAllChanges: join output plan:
[outputDF.queryExecution]
</code></pre></div> <p><code>writeAllChanges</code> requests the input <a href=../../OptimisticTransaction/ >OptimisticTransaction</a> to <a href=../../TransactionalWrite/#writeFiles>writeFiles</a> (possibly repartitioning by the partition columns if table is partitioned and <a href=../../DeltaSQLConf/#MERGE_REPARTITION_BEFORE_WRITE>spark.databricks.delta.merge.repartitionBeforeWrite.enabled</a> configuration property is enabled).</p> <p><code>writeAllChanges</code> is used when <code>MergeIntoCommand</code> is requested to <a href=#run>run</a>.</p> <h3 id=building-target-logical-query-plan-for-addfiles><span id=buildTargetPlanWithFiles> Building Target Logical Query Plan for AddFiles<a class=headerlink href=#building-target-logical-query-plan-for-addfiles title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=n>buildTargetPlanWithFiles</span><span class=o>(</span>
  <span class=n>deltaTxn</span><span class=k>:</span> <span class=kt>OptimisticTransaction</span><span class=o>,</span>
  <span class=n>files</span><span class=k>:</span> <span class=kt>Seq</span><span class=o>[</span><span class=kt>AddFile</span><span class=o>])</span><span class=k>:</span> <span class=kt>LogicalPlan</span>
</code></pre></div> <p><code>buildTargetPlanWithFiles</code> creates a DataFrame to represent the given <a href=../../AddFile/ >AddFile</a>s to access the analyzed logical query plan. <code>buildTargetPlanWithFiles</code> requests the given <a href=../../OptimisticTransaction/ >OptimisticTransaction</a> for the <a href=../../OptimisticTransaction/#deltaLog>DeltaLog</a> to <a href=../../DeltaLog/#createDataFrame>create a DataFrame</a> (for the <a href=../../OptimisticTransaction/#snapshot>Snapshot</a> and the given <a href=../../AddFile/ >AddFile</a>s).</p> <p>In the end, <code>buildTargetPlanWithFiles</code> creates a <code>Project</code> logical operator with <code>Alias</code> expressions so the output columns of the analyzed logical query plan (of the <code>DataFrame</code> of the <code>AddFiles</code>) reference the target's output columns (by name).</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The output columns of the target delta table are associated with a <a href=../../OptimisticTransaction/ >OptimisticTransaction</a> as the <a href=../../OptimisticTransactionImpl/#metadata>Metadata</a>.</p> <div class=highlight><pre><span></span><code><span class=n>deltaTxn</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>schema</span>
</code></pre></div> </div> <h3 id=writeinsertsonlywhennomatchedclauses><span id=writeInsertsOnlyWhenNoMatchedClauses> writeInsertsOnlyWhenNoMatchedClauses<a class=headerlink href=#writeinsertsonlywhennomatchedclauses title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=n>writeInsertsOnlyWhenNoMatchedClauses</span><span class=o>(</span>
  <span class=n>spark</span><span class=k>:</span> <span class=kt>SparkSession</span><span class=o>,</span>
  <span class=n>deltaTxn</span><span class=k>:</span> <span class=kt>OptimisticTransaction</span><span class=o>)</span><span class=k>:</span> <span class=kt>Seq</span><span class=o>[</span><span class=kt>AddFile</span><span class=o>]</span>
</code></pre></div> <p><code>writeInsertsOnlyWhenNoMatchedClauses</code>...FIXME</p> <h3 id=exceptions><span id=run-exceptions> Exceptions<a class=headerlink href=#exceptions title="Permanent link">&para;</a></h3> <p><code>run</code> throws an <code>AnalysisException</code> when the target schema is different than the delta table's (has changed after analysis phase):</p> <div class=highlight><pre><span></span><code>The schema of your Delta table has changed in an incompatible way since your DataFrame or DeltaTable object was created. Please redefine your DataFrame or DeltaTable object. Changes:
[schemaDiff]
This check can be turned off by setting the session configuration key spark.databricks.delta.checkLatestSchemaOnRead to false.
</code></pre></div> <h2 id=logging>Logging<a class=headerlink href=#logging title="Permanent link">&para;</a></h2> <p>Enable <code>ALL</code> logging level for <code>org.apache.spark.sql.delta.commands.MergeIntoCommand</code> logger to see what happens inside.</p> <p>Add the following line to <code>conf/log4j.properties</code>:</p> <div class=highlight><pre><span></span><code>log4j.logger.org.apache.spark.sql.delta.commands.MergeIntoCommand=ALL
</code></pre></div> <p>Refer to <a href=../../spark-logging/ >Logging</a>.</p> <hr> <div class=md-source-date> <small> Last update: 2020-11-19 </small> </div> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid" aria-label=Footer> <a href=../DeltaMergeInto/ class="md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> Previous </span> DeltaMergeInto </div> </div> </a> <a href=../JoinedRowProcessor/ class="md-footer-nav__link md-footer-nav__link--next" rel=next> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> Next </span> JoinedRowProcessor </div> </div> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2020 <a href=https://twitter.com/jaceklaskowski target=_blank rel=noopener>Jacek Laskowski</a> </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://github.com/jaceklaskowski target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://twitter.com/jaceklaskowski target=_blank rel=noopener title=twitter.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://linkedin.com/in/jaceklaskowski target=_blank rel=noopener title=linkedin.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/vendor.0ac82a11.min.js></script> <script src=../../assets/javascripts/bundle.f81dfb4d.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script> <script>
        app = initialize({
          base: "../..",
          features: ['navigation.tabs', 'navigation.instant'],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> </body> </html>